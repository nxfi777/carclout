# Fix: activation:first-template Event Not Firing

## Problem
The `activation:first-template` umami event was not firing because:

1. **API Changed to Async**: The `/api/templates/generate` endpoint was changed to async job queuing (returns `jobId` instead of immediate `url`/`key`)
2. **Client Not Updated**: The client code in `content-tabs-core.tsx` still expected immediate responses
3. **No Polling**: No polling mechanism for job completion
4. **No Event Dispatch**: Without completion detection, analytics events were never dispatched

## Solution

### 1. Created Async Image Generation Hook
**File**: `lib/use-async-image-generation.ts`

Similar to the existing `useAsyncVideoGeneration` hook:
- Handles job submission to `/api/templates/generate`
- Polls `/api/templates/generate/status` every 3 seconds
- Detects completion and extracts result
- **Dispatches analytics events**:
  - `template-generated` (always)
  - `first-template-generated` (only if `isFirstTemplate` flag is true)
  - `template-generation-failed` (on errors)

### 2. Updated Status Endpoint
**File**: `app/api/templates/generate/status/route.ts`

Added first-template detection:
```typescript
// Check if this is user's first completed template generation
const completedJobsRes = await db.query(
  "SELECT count() as count FROM image_job WHERE email = $email AND status = 'completed' GROUP ALL;",
  { email: user.email }
);
const isFirstTemplate = completedCount === 0;
```

Returns `isFirstTemplate: true` in the response when it's the user's first completed generation.

### 3. Updated Client Component
**File**: `components/ui/content-tabs-core.tsx`

Replaced all direct `fetch('/api/templates/generate')` calls with the new async hook:

**Changes:**
- Imported `useAsyncImageGeneration`
- Added hook instance: `const imageGeneration = useAsyncImageGeneration()`
- Updated `generate()` function to use hook with callbacks
- Updated `handleDesignerRegenerate()` to use hook
- Updated crop finalization functions to use hook
- Added `imageGeneration.isGenerating` to busy state checks

## How It Works Now

### Flow:
1. User clicks "Generate" button
2. Hook calls `/api/templates/generate` → receives `jobId`
3. Hook polls `/api/templates/generate/status?jobId=xxx` every 3 seconds
4. Status endpoint checks fal.ai, downloads result, saves to R2
5. On first successful completion, status endpoint queries DB for user's completion count
6. Status returns `{ status: 'completed', url, key, credits, isFirstTemplate: true/false }`
7. Hook dispatches events:
   - `window.dispatchEvent(new CustomEvent('template-generated', { detail: {...} }))`
   - If `isFirstTemplate`: `window.dispatchEvent(new CustomEvent('first-template-generated', { detail: {...} }))`
8. `UmamiTracker` component listens for these events and forwards to Umami

### Event Mapping in UmamiTracker:
```typescript
"template-generated": "engagement:template",
"first-template-generated": "activation:first-template",
"template-generation-failed": "friction:generation-fail",
```

## Testing

To verify the fix works:

1. **Browser Console**: Open DevTools → Console
2. **Generate a Template**: Use a fresh test account
3. **Watch for Logs**: 
   ```
   [IMAGE] Job started: xxx
   [IMAGE] Poll 1: status=pending
   [IMAGE] Poll 2: status=processing
   [IMAGE] Poll 3: status=completed
   [IMAGE] Generation complete: users/xxx/library/gen-xxx.jpg
   [ACTIVATION] First template generated!
   ```
4. **Check Umami**: Events should appear:
   - `engagement:template` (always)
   - `activation:first-template` (first generation only)

5. **Server Logs**: Check for:
   ```
   [ACTIVATION] First template generated by: user@example.com
   ```

## Database Tracking

The `image_job` table tracks all generation jobs:
- `status`: 'pending', 'processing', 'completed', 'failed'
- `email`: User's email
- `fal_request_id`: Job ID from fal.ai
- `completed_at`: Timestamp when job completed

The count query uses this to determine first-time generation:
```sql
SELECT count() as count 
FROM image_job 
WHERE email = $email AND status = 'completed' 
GROUP ALL;
```

## Files Modified

1. ✅ `lib/use-async-image-generation.ts` (created)
2. ✅ `app/api/templates/generate/status/route.ts` (updated)
3. ✅ `components/ui/content-tabs-core.tsx` (updated)

## Related Events

Other activation events that should also be tracked:
- `activation:first-vehicle` - User adds first vehicle
- `activation:first-message` - User sends first chat message
- `activation:first-upload` - User uploads first file
- `activation:onboarding-complete` - User completes onboarding

See `ANALYTICS_EVENTS_IMPLEMENTED.md` for full event catalog.

## Umami Reports to Build

Now that events are firing, create these reports:

1. **Insights Report**: "Activation Event Performance"
   - Filter by `activation:*` events
   - See which activation events drive retention

2. **Funnel Report**: "User Activation Journey"
   - Step 1: Page view
   - Step 2: `activation:first-template`
   - Step 3: `activation:first-vehicle`
   - Goal: 70%+ complete step 2 in first session

3. **Retention Report**: "Activated vs Non-Activated Users"
   - Cohort A: Users with `activation:first-template`
   - Cohort B: Users without
   - Compare return rates (should be 3-4x higher for A)

See `UMAMI_REPORTS_GUIDE.md` for detailed setup instructions.

